---
title: "Discrimatory marker selection"
author: "John Mulvey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: flatly
    highlight: tango
  html_document:
    toc: yes
    df_print: paged
---

In GTEx transcriptome.Rmd, we explore how the transcriptome (espeacially that of a predefined set of metabolic genes of interest) differes between different tissue.

In order to provide a practical reommendation in the paper, Jan has suggested that we come up with a small panel of genes that could feasibly be measured by e.g. qPCR in the lab, in order that people may check that their model system (cell culture, organoids, perhaps even as far as ex vivo perfued organs) sufficiently recapitualtes human organ physiology.

# Load packages
```{r}
library(tidymodels)
library(themis)
library(vip)
library(rpart.plot)
#library(stringr)
library(pheatmap)
```


# Load and wrangle data
```{r}
readRDS(log_tpm_tmm_goi, file = "../results/log_tpm_tmm_goi.rds")
readRDS(sample_meta, file = "../results/sample_meta.rds")
readRDS(log_tpm_grouped_tmm_goi, file = "../results/log_tpm_grouped_tmm_goi.rds")

metabolic_genes = log_tpm_tmm_goi %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("SAMPID") %>%
  left_join(sample_meta %>% dplyr::select(SAMPID, tissue), by = "SAMPID", na_matches = "never")
```


# Preprocess
```{r}
set.seed(123)
metabolic_genes_split <- initial_split(metabolic_genes, strata = tissue)
metabolic_genes_train <- training(metabolic_genes_split)
metabolic_genes_test <- testing(metabolic_genes_split)

# check stratified sampling
metabolic_genes_test %>%
  group_by(tissue) %>%
  summarise(n = n())

sample_meta %>%
  group_by(tissue) %>%
  summarise(n = n())

metabolic_genes_trees_rec <- recipe(tissue ~ ., data = metabolic_genes_train) %>%
  update_role(SAMPID, new_role = "ID") %>%
  step_nzv(all_predictors()) %>%
  themis::step_smote(tissue, seed = 456)

metabolic_genes_trees_prep <- prep(metabolic_genes_trees_rec)
metabolic_genes_trees_juiced <- juice(metabolic_genes_trees_prep)
```


# Random forest
```{r}
rf_spec <- rand_forest(trees = 1000) %>%
  set_mode("classification") %>%
  set_engine("ranger")

rf_wf <- workflow() %>%
  add_recipe(metabolic_genes_trees_rec) %>%
  add_model(rf_spec)

rf_res = rf_wf %>%
  last_fit(metabolic_genes_split)
```


# Examine results
## Confusion matrix
```{r}
rf_res %>%
  collect_metrics()

rf_res %>%
  collect_predictions() %>%
  conf_mat(tissue, .pred_class)

rf_res %>%
  collect_predictions() %>%
  group_by(tissue) %>%
  summarise(n = n())
```

## Variable importance
```{r}
rf_spec %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(tissue ~ .,
    data = metabolic_genes_trees_juiced) %>%
  vip(geom = "point") +
  scale_y_continuous(expand = c(0, 0))
```


```{r}
metabolic_genes_pred <- rf_res %>%
  collect_predictions() %>%
  mutate(correct = tissue == .pred_class) %>%
  left_join(metabolic_genes %>%
    mutate(.row = row_number()))
```

# Decision trees
## define workflow
```{r}
decision_trees_spec <- decision_tree(tree_depth = 5) %>%
  set_mode("classification") %>%
  set_engine("rpart")

decision_trees_wf <- workflow() %>%
  add_recipe(metabolic_genes_trees_rec) %>%
  add_model(decision_trees_spec)

decision_trees_res = decision_trees_wf %>%
  last_fit(metabolic_genes_split)
```


## Examine results
### Confusion matrix
```{r}
decision_trees_res %>%
  collect_metrics()

decision_trees_res %>%
  collect_predictions() %>%
  conf_mat(tissue, .pred_class)
```


### Plot decision trees
```{r}
# decision_trees_spec %>%
#   fit(tissue ~ .,
#     data = metabolic_genes_trees_juiced) %>%
#   vip(geom = "point") +
#   scale_y_continuous(expand = c(0, 0))

decision_tree_fit <- decision_trees_wf %>% 
   fit(metabolic_genes_train) %>%
  pull_workflow_fit()
rpart.plot(decision_tree_fit$fit)

decision_tree_fit # show tree
```

### plot gene expression per tissue
ENSG00000021826 \# liver CPS1 carbamoyl-phosphate synthase 1 
ENSG00000113492 \# kidney AGXT2 alanine--glyoxylate aminotransferase 2 
ENSG00000130957 #skeletal muscle FBP2 fructose-1,6-bisphosphatase 2 
ENSG00000166183 #heart LV vs AA ASPG asparaginase
```{r}
log_tpm_tmm_goi_long_sample = log_tpm_tmm_goi %>%
  as.data.frame() %>%
  rownames_to_column("ENSG") %>%
  pivot_longer(!ENSG, names_to = "sample", values_to = "log_tpm_tmm") %>%
  left_join(sample_meta, by = c("sample"="SAMPID"))

discriminant_genes = c("ENSG00000021826", "ENSG00000113492", "ENSG00000130957", "ENSG00000166183")

for (i in discriminant_genes){
    print(log_tpm_tmm_goi_long_sample %>%
      filter(str_detect(ENSG, i)) %>%
      ggplot(aes(x = tissue, y = log_tpm_tmm, group = tissue)) +
      geom_violin(fill = "darkgrey"))
}

pheat_inf_tissue = sample_meta %>%
  column_to_rownames("SAMPID") %>%
  dplyr::select("tissue")

log_tpm_tmm_goi %>%
  rownames_to_column("ensembl_gene_id") %>%
  filter(ensembl_gene_id %in% discriminant_genes) %>%
  column_to_rownames("ensembl_gene_id") %>%
pheatmap(scale = "none",
                   clustering_method = "ward.D2",
                   cluster_rows = T,
                   clustering_distance_rows = "euclidean",
                   cluster_cols = T,
                   clustering_distance_cols = "euclidean",
                   show_rownames = TRUE,
                   fontsize_row = 3,
                   fontsize_col = 5,
                   angle_col = 45,
         annotation_col=pheat_inf_tissue,
         annotation_names_col = FALSE,
                   main = "Heatmap of discriminatory genes")

log_tpm_grouped_tmm_goi %>%
  rownames_to_column("ensembl_gene_id") %>%
  filter(ensembl_gene_id %in% discriminant_genes) %>%
  column_to_rownames("ensembl_gene_id") %>%
pheatmap(scale = "none",
                   clustering_method = "ward.D2",
                   cluster_rows = T,
                   clustering_distance_rows = "euclidean",
                   cluster_cols = T,
                   clustering_distance_cols = "euclidean",
                   show_rownames = TRUE,
                   fontsize_row = 3,
                   fontsize_col = 5,
                   angle_col = 45,
                   main = "Heatmap of discriminatory genes")
```

# Combined heart tissue
```{r}
metabolic_genes_simp = metabolic_genes %>%
  mutate(tissue = case_when(tissue %in% c("Heart_Atrial_Appendage", "Heart_Left_Ventricle") ~ "Heart",
                            TRUE ~ as.character(tissue)) %>%
           as.factor())

set.seed(123)
metabolic_genes_simp_split <- initial_split(metabolic_genes_simp, strata = tissue)
metabolic_genes_simp_train <- training(metabolic_genes_simp_split)
metabolic_genes_simp_test <- testing(metabolic_genes_simp_split)

# check stratified sampling
metabolic_genes_simp_test %>%
  group_by(tissue) %>%
  summarise(n = n())

sample_meta %>%
  group_by(tissue) %>%
  summarise(n = n())

metabolic_genes_simp_trees_rec <- recipe(tissue ~ ., data = metabolic_genes_simp_train) %>%
  update_role(SAMPID, new_role = "ID") %>%
  step_nzv(all_predictors()) %>%
  themis::step_smote(tissue, seed = 456)

metabolic_genes_simp_trees_prep <- prep(metabolic_genes_simp_trees_rec)
metabolic_genes_simp_trees_juiced <- juice(metabolic_genes_simp_trees_prep)
```


## Decision trees
## define workflow
```{r}
decision_trees_spec <- decision_tree(tree_depth = 5) %>%
  set_mode("classification") %>%
  set_engine("rpart")

decision_trees_wf <- workflow() %>%
  add_recipe(metabolic_genes_simp_trees_rec) %>%
  add_model(decision_trees_spec)

decision_trees_res = decision_trees_wf %>%
  last_fit(metabolic_genes_simp_split)
```


## Examine results
### Confusion matrix
```{r}
decision_trees_res %>%
  collect_metrics()

decision_trees_res %>%
  collect_predictions() %>%
  conf_mat(tissue, .pred_class)
```


### Plot decision trees
```{r}
decision_tree_fit <- decision_trees_wf %>% 
   fit(metabolic_genes_simp_train) %>%
  pull_workflow_fit()
rpart.plot(decision_tree_fit$fit)

decision_tree_fit # show tree
```

### plot gene expression per tissue
ENSG00000021826 \# liver CPS1 carbamoyl-phosphate synthase 1 
ENSG00000113492 \# kidney AGXT2 alanine--glyoxylate aminotransferase 2 
ENSG00000130957 #skeletal muscle FBP2 fructose-1,6-bisphosphatase 2 
ENSG00000166183 #heart LV vs AA ASPG asparaginase
```{r}
log_tpm_tmm_goi_long_sample = log_tpm_tmm_goi %>%
  as.data.frame() %>%
  rownames_to_column("ENSG") %>%
  pivot_longer(!ENSG, names_to = "sample", values_to = "log_tpm_tmm") %>%
  left_join(sample_meta, by = c("sample"="SAMPID"))

discriminant_genes = c("ENSG00000021826", "ENSG00000113492", "ENSG00000130957", "ENSG00000166183")

for (i in discriminant_genes){
    print(log_tpm_tmm_goi_long_sample %>%
      filter(str_detect(ENSG, i)) %>%
      ggplot(aes(x = tissue, y = log_tpm_tmm, group = tissue)) +
      geom_violin(fill = "darkgrey"))
}

pheat_inf_tissue = sample_meta %>%
  column_to_rownames("SAMPID") %>%
  dplyr::select("tissue")

log_tpm_tmm_goi %>%
  rownames_to_column("ensembl_gene_id") %>%
  filter(ensembl_gene_id %in% discriminant_genes) %>%
  column_to_rownames("ensembl_gene_id") %>%
pheatmap(scale = "none",
                   clustering_method = "ward.D2",
                   cluster_rows = T,
                   clustering_distance_rows = "euclidean",
                   cluster_cols = T,
                   clustering_distance_cols = "euclidean",
                   show_rownames = TRUE,
                   fontsize_row = 3,
                   fontsize_col = 5,
                   angle_col = 45,
         annotation_col=pheat_inf_tissue,
         annotation_names_col = FALSE,
                   main = "Heatmap of discriminatory genes")

log_tpm_grouped_tmm_goi %>%
  rownames_to_column("ensembl_gene_id") %>%
  filter(ensembl_gene_id %in% discriminant_genes) %>%
  column_to_rownames("ensembl_gene_id") %>%
pheatmap(scale = "none",
                   clustering_method = "ward.D2",
                   cluster_rows = T,
                   clustering_distance_rows = "euclidean",
                   cluster_cols = T,
                   clustering_distance_cols = "euclidean",
                   show_rownames = TRUE,
                   fontsize_row = 3,
                   fontsize_col = 5,
                   angle_col = 45,
                   main = "Heatmap of discriminatory genes")
```
